#!/bin/sh

# Interestings options:
# --opts="-P full.bleed=1" => add crop margins for print PDF for Lulu
# --opts="-V" => verbose mode of dblatex
# --lang=de-DE => build a translation

set -e

. $(dirname $0)/common.sh

check_cwd

OPT_lang="en-US"
version=$(get_product_version)
topdir=$(pwd)

parse_options "$@"

get_babel_sty() {
    case "$1" in
	en-US) echo "USenglish" ;;
	da-DK) echo "danish" ;;
	de-DE) echo "germanb" ;;
	el-GR) echo "greek" ;;
	es-ES) echo "spanish" ;;
	fr-FR) echo "frenchb" ;;
	it-IT) echo "italian" ;;
	pl-PL) echo "polish" ;;
	pt-BR) echo "portuges" ;;
	ro-RO) echo "romanian" ;;
	tr-TR) echo "turkish" ;;
	*)
	    echo "WARNING: Don't know proper babel .sty for $1" >&2
	;;
    esac
}

babel=$(get_babel_sty $OPT_lang)
if [ -n "$babel" ]; then
    OPT_opts="-P latex.babel.language=$babel $OPT_opts"
fi

if [ ! -e tmp/$OPT_lang/xml ] || [ -z "$OPT_skip" ]; then
    publican build --config=publican-pdf.cfg --formats=xml --langs=$OPT_lang
fi

cp -a build/dblatex tmp/$OPT_lang/xml/
cd tmp/$OPT_lang/xml/

echo "RUN: dblatex -c dblatex/librement.conf $OPT_opts debian-handbook.xml"
if dblatex -c dblatex/librement.conf $OPT_opts debian-handbook.xml; then
    targetdir="$topdir/publish/$OPT_lang/Debian/$version/pdf/debian-handbook"
    mkdir -p $targetdir
    cp debian-handbook.pdf $targetdir/
    echo "SUCCESS: $targetdir/debian-handbook.pdf"
else
    echo "ERROR: Failed to build PDF version for $OPT_lang"
    exit 1
fi

